# =============================================================================
# SynthStack Community Edition - CI Workflow
# =============================================================================
# This workflow runs tests and linting for the community edition.
# 
# For deployment workflows, see docs/DEPLOYMENT_GUIDE.md
# The deployment jobs are commented out below and can be enabled when you have:
#   - Your own server infrastructure
#   - GitHub secrets configured (REMOTE_HOST, SSH keys, etc.)
# =============================================================================

name: CI

on:
  push:
    branches: ["main", "master", "develop"]
  pull_request:
    branches: ["main", "master", "develop"]

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

jobs:
  # =========================================
  # Code Quality & Testing
  # =========================================
  test:
    name: Test & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Linting
        run: pnpm lint
        continue-on-error: true

      - name: Run Type Checking
        run: pnpm typecheck
        continue-on-error: true

      - name: Run Unit Tests
        run: pnpm test
        continue-on-error: true

  # =========================================
  # Build Frontend
  # =========================================
  build-web:
    name: Build Web App
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Web Application
        run: pnpm --filter @synthstack/web build
        env:
          # These can be overridden via GitHub repository variables
          VITE_API_URL: ${{ vars.VITE_API_URL || 'http://localhost:3003' }}
          VITE_SUPABASE_URL: ${{ vars.VITE_SUPABASE_URL || '' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || '' }}

      - name: Upload Web Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist/spa
          retention-days: 7

# =============================================================================
# DEPLOYMENT JOBS (DISABLED)
# =============================================================================
# Uncomment and configure these jobs for production deployment.
# Required secrets:
#   - REMOTE_HOST_PRODUCTION: Your server IP
#   - REMOTE_USER: SSH username (usually 'root')
#   - REMOTE_SSH_KEY: Your SSH private key
#   - GH_PAT: GitHub Personal Access Token for pulling images
#
# See docs/DEPLOYMENT_GUIDE.md for full setup instructions.
# =============================================================================

# build-api:
#   name: Build API Docker Image
#   runs-on: ubuntu-latest
#   needs: test
#   if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
#
#   permissions:
#     contents: read
#     packages: write
#
#   steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#
#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v3
#
#     - name: Login to GitHub Container Registry
#       uses: docker/login-action@v3
#       with:
#         registry: ghcr.io
#         username: ${{ github.actor }}
#         password: ${{ secrets.GITHUB_TOKEN }}
#
#     - name: Build and push API image
#       uses: docker/build-push-action@v5
#       with:
#         context: .
#         file: ./packages/api-gateway/Dockerfile
#         push: true
#         tags: ghcr.io/${{ github.repository }}/api:latest

# deploy-production:
#   name: Deploy to Production
#   runs-on: ubuntu-latest
#   needs: [build-web, build-api]
#   if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
#   environment: production
#
#   steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#
#     - name: Download Web Build
#       uses: actions/download-artifact@v4
#       with:
#         name: web-dist
#         path: ./dist
#
#     - name: Setup SSH Key
#       run: |
#         mkdir -p ~/.ssh
#         echo "${{ secrets.REMOTE_SSH_KEY }}" > ~/.ssh/deploy_key
#         chmod 600 ~/.ssh/deploy_key
#         ssh-keyscan -H ${{ secrets.REMOTE_HOST_PRODUCTION }} >> ~/.ssh/known_hosts
#
#     - name: Deploy Web to Production
#       run: |
#         rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" \
#           ./dist/ ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST_PRODUCTION }}:/var/www/synthstack/
#
#     - name: Deploy Services
#       run: |
#         ssh -i ~/.ssh/deploy_key ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST_PRODUCTION }} \
#           'cd /opt/synthstack && docker compose pull && docker compose up -d'
