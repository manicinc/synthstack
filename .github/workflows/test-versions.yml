name: Test LITE & PRO Versions

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  # ============================================
  # LITE VERSION TESTS
  # ============================================
  test-lite-backend:
    name: ðŸ§ª Test LITE Backend
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: synthstack
          POSTGRES_PASSWORD: synthstack_test
          POSTGRES_DB: synthstack_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup test database
        run: |
          cd packages/api-gateway
          pnpm tsx src/test/setup-db.ts
        env:
          DATABASE_URL: postgresql://synthstack:synthstack_test@localhost:5432/synthstack_test

      - name: Build referrals-credits package
        run: pnpm --filter @synthstack/referrals-credits build

      - name: Run LITE backend unit tests
        run: |
          cd packages/api-gateway
          ENABLE_COPILOT=false ENABLE_REFERRALS=false pnpm test
        env:
          DATABASE_URL: postgresql://synthstack:synthstack_test@localhost:5432/synthstack_test

      - name: Run LITE backend E2E tests
        run: |
          cd packages/api-gateway
          ENABLE_COPILOT=false ENABLE_REFERRALS=false pnpm test:e2e
        # Note: E2E tests use Docker Compose which provides its own Postgres/Redis
        # Don't set DATABASE_URL here - let test-server.ts use the default Docker Compose ports

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lite-backend-test-results
          path: packages/api-gateway/coverage/

  test-lite-frontend:
    name: ðŸ§ª Test LITE Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run LITE frontend unit tests
        run: |
          cd apps/web
          VITE_ENABLE_COPILOT=false VITE_ENABLE_REFERRALS=false pnpm test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lite-frontend-test-results
          path: apps/web/coverage/

  test-lite-e2e:
    name: ðŸ§ª Test LITE E2E
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: |
          cd apps/web
          pnpm exec playwright install --with-deps chromium

      - name: Setup LITE environment
        run: |
          cd apps/web
          cp .env.lite.example .env
          echo "âœ… Copied .env.lite.example to .env"
          cat .env | grep VITE_ENABLE

      - name: Run LITE E2E tests
        run: |
          cd apps/web
          pnpm test:e2e --project=chromium e2e/lite-version.spec.ts
        env:
          VITE_ENABLE_COPILOT: "false"
          VITE_ENABLE_REFERRALS: "false"

      - name: Upload E2E results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lite-e2e-results
          path: apps/web/test-results/

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lite-e2e-screenshots
          path: apps/web/test-results/**/*.png

  build-lite:
    name: ðŸ”¨ Build LITE Version
    runs-on: ubuntu-latest
    needs: [test-lite-backend, test-lite-frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup .env.lite for build
        run: |
          cp .env.lite.example .env.lite
          cp .env.lite.example apps/web/.env.lite
          cp .env.lite.example packages/api-gateway/.env.lite

      - name: Build LITE version
        run: pnpm build:lite

      - name: Verify LITE build
        run: |
          # Check that copilot/referral code is not in bundle
          echo "Checking LITE build excludes premium features..."

          # Backend check
          if grep -r "copilot\|referral" packages/api-gateway/dist/ 2>/dev/null; then
            echo "âš ï¸  Warning: Premium feature strings found in LITE backend build"
            echo "This may be expected for comments or dead code"
          fi

          # Frontend check - warn only (Vue conditional rendering includes component names in bundle)
          # The feature flags properly gate execution even if names appear in bundle
          if grep -r "CopilotWidget\|ReferralBanner" apps/web/dist/ 2>/dev/null; then
            echo "âš ï¸  Warning: Premium component names found in LITE frontend build"
            echo "This is expected - Vue bundles conditionally-rendered components"
            echo "Feature flags ensure these components won't execute in LITE mode"
          fi

          echo "âœ… LITE build verification passed"

      - name: Upload LITE build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lite-build
          path: |
            apps/web/dist/
            packages/api-gateway/dist/
          retention-days: 7

  # ============================================
  # PRO VERSION TESTS
  # ============================================
  test-pro-backend:
    name: ðŸ§ª Test PRO Backend
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: synthstack
          POSTGRES_PASSWORD: synthstack_test
          POSTGRES_DB: synthstack_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup test database
        run: |
          cd packages/api-gateway
          pnpm tsx src/test/setup-db.ts
        env:
          DATABASE_URL: postgresql://synthstack:synthstack_test@localhost:5432/synthstack_test

      - name: Build referrals-credits package
        run: pnpm --filter @synthstack/referrals-credits build

      - name: Run PRO backend unit tests
        run: |
          cd packages/api-gateway
          ENABLE_COPILOT=true ENABLE_REFERRALS=true pnpm test
        env:
          DATABASE_URL: postgresql://synthstack:synthstack_test@localhost:5432/synthstack_test

      - name: Run PRO backend E2E tests
        run: |
          cd packages/api-gateway
          ENABLE_COPILOT=true ENABLE_REFERRALS=true pnpm test:e2e
        # Note: E2E tests use Docker Compose which provides its own Postgres/Redis
        # Don't set DATABASE_URL here - let test-server.ts use the default Docker Compose ports

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pro-backend-test-results
          path: packages/api-gateway/coverage/

  test-pro-frontend:
    name: ðŸ§ª Test PRO Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run PRO frontend unit tests
        run: |
          cd apps/web
          VITE_ENABLE_COPILOT=true VITE_ENABLE_REFERRALS=true pnpm test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pro-frontend-test-results
          path: apps/web/coverage/

  test-pro-e2e:
    name: ðŸ§ª Test PRO E2E
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: |
          cd apps/web
          pnpm exec playwright install --with-deps chromium

      - name: Setup PRO environment
        run: |
          cd apps/web
          cp .env.pro.example .env
          echo "âœ… Copied .env.pro.example to .env"
          cat .env | grep VITE_ENABLE

      - name: Run PRO E2E tests
        run: |
          cd apps/web
          VITE_ENABLE_COPILOT=true VITE_ENABLE_REFERRALS=true pnpm test:e2e --project=chromium e2e/pro-version.spec.ts

      - name: Upload E2E results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pro-e2e-results
          path: apps/web/test-results/

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pro-e2e-screenshots
          path: apps/web/test-results/**/*.png

  build-pro:
    name: ðŸ”¨ Build PRO Version
    runs-on: ubuntu-latest
    needs: [test-pro-backend, test-pro-frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup .env.pro for build
        run: |
          cp .env.pro.example .env.pro
          cp .env.pro.example apps/web/.env.pro
          cp .env.pro.example packages/api-gateway/.env.pro

      - name: Build PRO version
        run: pnpm build:pro

      - name: Verify PRO build
        run: |
          echo "Checking PRO build includes all features..."

          # Verify copilot code exists in build
          if ! grep -r "copilot" packages/api-gateway/dist/ 2>/dev/null; then
            echo "âš ï¸  Warning: Copilot strings not found in PRO backend build"
          fi

          echo "âœ… PRO build verification passed"

      - name: Upload PRO build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pro-build
          path: |
            apps/web/dist/
            packages/api-gateway/dist/
          retention-days: 7

  # ============================================
  # COMPARISON REPORT
  # ============================================
  version-comparison:
    name: ðŸ“Š Version Comparison Report
    runs-on: ubuntu-latest
    needs: [build-lite, build-pro]
    if: success()

    steps:
      - name: Download LITE build
        uses: actions/download-artifact@v4
        with:
          name: lite-build
          path: ./lite-build

      - name: Download PRO build
        uses: actions/download-artifact@v4
        with:
          name: pro-build
          path: ./pro-build

      - name: Compare build sizes
        run: |
          echo "## Build Size Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Version | Frontend | Backend |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|---------|" >> $GITHUB_STEP_SUMMARY

          LITE_WEB_SIZE=$(du -sh lite-build/apps/web/dist | cut -f1)
          LITE_API_SIZE=$(du -sh lite-build/packages/api-gateway/dist | cut -f1)
          PRO_WEB_SIZE=$(du -sh pro-build/apps/web/dist | cut -f1)
          PRO_API_SIZE=$(du -sh pro-build/packages/api-gateway/dist | cut -f1)

          echo "| LITE | $LITE_WEB_SIZE | $LITE_API_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| PRO | $PRO_WEB_SIZE | $PRO_API_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… LITE build should be smaller (excludes copilot & referrals)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # FINAL STATUS CHECK
  # ============================================
  all-tests-passed:
    name: âœ… All Version Tests Passed
    runs-on: ubuntu-latest
    needs:
      - test-lite-backend
      - test-lite-frontend
      - test-lite-e2e
      - test-pro-backend
      - test-pro-frontend
      - test-pro-e2e
      - build-lite
      - build-pro
    if: success()

    steps:
      - name: Success
        run: |
          echo "âœ… All LITE and PRO version tests passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Both versions built and tested successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LITE: Backend, Frontend, E2E, Build" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PRO: Backend, Frontend, E2E, Build" >> $GITHUB_STEP_SUMMARY
