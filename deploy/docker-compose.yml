# SynthStack Production Docker Compose
# VPS/Cloud deployment configuration (provider-agnostic)
# Compatible with: Linode, DigitalOcean, AWS, Vultr, Hetzner, and any VPS
#
# =========================================
# BRANDING & DOMAIN CONFIGURATION
# =========================================
# All container names and domains are configurable via environment variables.
# Set these BEFORE running docker compose:
#
#   export APP_DOMAIN=yourapp.com
#   export CONTAINER_PREFIX=yourapp
#   docker compose -f deploy/docker-compose.yml up -d
#
# See docs/REBRANDING_GUIDE.md for complete instructions.
# =========================================

version: '3.8'

services:
  # =========================================
  # Reverse Proxy (Traefik)
  # =========================================
  traefik:
    image: traefik:v3.0
    container_name: ${CONTAINER_PREFIX:-synthstack}-traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./certs:/certs
      - traefik-acme:/acme
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      # Dashboard (optional, secured)
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${APP_DOMAIN:-synthstack.app}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth"

  # =========================================
  # API Gateway (Node.js/Fastify)
  # =========================================
  api:
    image: ghcr.io/${GITHUB_ORG:-manicinc}/${CONTAINER_PREFIX:-synthstack}/api:latest
    container_name: ${CONTAINER_PREFIX:-synthstack}-api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      # Database
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis:6379
      # Directus CMS
      - DIRECTUS_URL=http://directus:8055
      - DIRECTUS_TOKEN=${DIRECTUS_ADMIN_TOKEN}
      # Supabase Auth
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      # Stripe
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      # Cloudflare R2 Storage
      - CLOUDFLARE_R2_ACCESS_KEY=${CLOUDFLARE_R2_ACCESS_KEY}
      - CLOUDFLARE_R2_SECRET_KEY=${CLOUDFLARE_R2_SECRET_KEY}
      - CLOUDFLARE_R2_BUCKET=${CLOUDFLARE_R2_BUCKET}
      # ML Service (TypeScript)
      - ML_SERVICE_URL=http://ts-ml-service:8001
      # AI APIs
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # GitHub Organization Access
      - GH_PAT=${GH_PAT}
      - GITHUB_ORG_PAT=${GITHUB_ORG_PAT}
      - GITHUB_ORG_NAME=${GITHUB_ORG_NAME:-manicinc}
      - GITHUB_TEAM_SLUG=${GITHUB_TEAM_SLUG:-synthstack-pro}
      # Email Service (Resend)
      - RESEND_API_KEY=${RESEND_API_KEY}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL}
      - RESEND_FROM_NAME=${RESEND_FROM_NAME}
      # Auth
      - JWT_SECRET=${JWT_SECRET}
      # Optional: Qdrant Vector DB
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      directus:
        condition: service_started
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.${APP_DOMAIN:-synthstack.app}`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.services.api.loadbalancer.server.port=3000"
    healthcheck:
      test: [ "CMD-SHELL", "node -e \"fetch('http://localhost:3000/health').then(r=>r.ok?process.exit(0):process.exit(1)).catch(()=>process.exit(1))\"" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =========================================
  # ML Service (TypeScript/NestJS) - Community Edition
  # =========================================
  ts-ml-service:
    image: ghcr.io/${GITHUB_ORG:-manicinc}/${CONTAINER_PREFIX:-synthstack}/ts-ml-service:latest
    container_name: ${CONTAINER_PREFIX:-synthstack}-ts-ml
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=8001
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=${DATABASE_URL}
    depends_on:
      - redis
    networks:
      - app-network
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =========================================
  # PostgreSQL Database
  # =========================================
  postgres:
    image: postgres:16-alpine
    container_name: ${CONTAINER_PREFIX:-synthstack}-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${DATABASE_NAME:-synthstack}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${DATABASE_NAME:-synthstack}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================================
  # Redis Cache
  # =========================================
  redis:
    image: redis:7-alpine
    container_name: ${CONTAINER_PREFIX:-synthstack}-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - app-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================================
  # Directus CMS
  # =========================================
  directus:
    build:
      context: ../services/directus
      dockerfile: Dockerfile
    container_name: ${CONTAINER_PREFIX:-synthstack}-directus
    restart: unless-stopped
    environment:
      - KEY=${DIRECTUS_KEY}
      - SECRET=${DIRECTUS_SECRET}
      - DB_CLIENT=pg
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=${DATABASE_NAME:-synthstack}
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - ADMIN_EMAIL=${DIRECTUS_ADMIN_EMAIL}
      - ADMIN_PASSWORD=${DIRECTUS_ADMIN_PASSWORD}
      - ADMIN_TOKEN=${DIRECTUS_ADMIN_TOKEN}
      - PUBLIC_URL=https://admin.${APP_DOMAIN:-synthstack.app}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app-network
    volumes:
      - directus-uploads:/directus/uploads
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.directus.rule=Host(`admin.${APP_DOMAIN:-synthstack.app}`)"
      - "traefik.http.routers.directus.entrypoints=websecure"
      - "traefik.http.routers.directus.tls.certresolver=letsencrypt"
      - "traefik.http.services.directus.loadbalancer.server.port=8055"
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://0.0.0.0:8055/server/ping || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # =========================================
  # Directus Schema + Seed Migrations (Runs after Directus creates its schema)
  # =========================================
  directus-migrate:
    image: postgres:16-alpine
    restart: "no"
    environment:
      PGHOST: postgres
      PGPORT: 5432
      PGDATABASE: ${DATABASE_NAME:-synthstack}
      PGUSER: ${POSTGRES_USER}
      PGPASSWORD: ${POSTGRES_PASSWORD}
    depends_on:
      directus:
        condition: service_healthy
    volumes:
      - ../services/directus/migrations:/migrations:ro
    entrypoint: [ "/bin/sh", "-c" ]
    command:
      - |
        echo "Running SynthStack Directus migrations..."
        echo "Waiting for Directus to initialize its schema..."

        # Wait for Directus to create its tables (max 120 seconds)
        for i in $$(seq 1 120); do
          if psql -At -c "SELECT 1 FROM information_schema.tables WHERE table_name = 'directus_users' LIMIT 1;" | grep -q 1; then
            echo "Directus schema ready!"
            break
          fi
          echo "Waiting for Directus schema... ($$i/120)"
          sleep 1
        done

        # Ensure migration tracking table exists
        psql -v ON_ERROR_STOP=1 -c "CREATE TABLE IF NOT EXISTS synthstack_migrations (filename TEXT PRIMARY KEY, applied_at TIMESTAMPTZ NOT NULL DEFAULT NOW());"

        # Run each migration file once (in lexicographic order)
        for f in /migrations/*.sql; do
          if [ -f "$$f" ]; then
            NAME=$$(basename "$$f")
            APPLIED=$$(psql -At -c "SELECT 1 FROM synthstack_migrations WHERE filename = '$$NAME' LIMIT 1;")

            if [ "$$APPLIED" = "1" ]; then
              echo "Skipping already applied: $$NAME"
              continue
            fi

            echo "Running migration: $$NAME"
            psql -v ON_ERROR_STOP=1 -f "$$f"
            psql -v ON_ERROR_STOP=1 -c "INSERT INTO synthstack_migrations (filename) VALUES ('$$NAME');"
          fi
        done

        echo ""
        echo "Migrations complete!"

  # =========================================
  # Backup Service
  # =========================================
  backup:
    image: prodrigestivill/postgres-backup-local:16
    container_name: ${CONTAINER_PREFIX:-synthstack}-backup
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=${DATABASE_NAME:-synthstack}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - SCHEDULE=@daily
      - BACKUP_KEEP_DAYS=7
      - BACKUP_KEEP_WEEKS=4
      - BACKUP_KEEP_MONTHS=6
    volumes:
      - ./backups:/backups
    depends_on:
      - postgres
    networks:
      - app-network

  # =========================================
  # Web Frontend (Static Vue.js SPA)
  # =========================================
  web:
    image: nginx:alpine
    container_name: ${CONTAINER_PREFIX:-synthstack}-web
    restart: unless-stopped
    volumes:
      - /var/www/${CONTAINER_PREFIX:-synthstack}:/usr/share/nginx/html:ro
      - ./nginx/app.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`${APP_DOMAIN:-synthstack.app}`) || Host(`www.${APP_DOMAIN:-synthstack.app}`)"
      - "traefik.http.routers.web.entrypoints=websecure"
      - "traefik.http.routers.web.tls.certresolver=letsencrypt"
      - "traefik.http.services.web.loadbalancer.server.port=80"
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# =========================================
# Networks
# =========================================
networks:
  app-network:
    name: ${NETWORK_NAME:-synthstack-network}
    driver: bridge

# =========================================
# Volumes
# =========================================
volumes:
  postgres-data:
  redis-data:
  directus-uploads:
  traefik-acme:
